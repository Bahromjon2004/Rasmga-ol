<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kamera ‚Äî Suratni Saqlash (PHP-siz)</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root { --bg:#0b0b0c; --fg:#f5f7fb; --muted:#9aa3af; --card:#16181d; --accent:#3b82f6; }
    @media (prefers-color-scheme: light) {
      :root { --bg:#f6f7fb; --fg:#0b1220; --muted:#6b7280; --card:#ffffff; --accent:#1d4ed8; }
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
    .wrap{max-width:820px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid #00000022;border-radius:16px;padding:16px;box-shadow:0 8px 30px #00000020}
    h1{margin:0 0 8px;font-size:20px}
    p{margin:.25rem 0;color:var(--muted)}
    .media{display:grid;gap:12px}
    video,canvas,img{width:100%;border-radius:12px;background:#000}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    button,.btn{
      appearance:none;border:0;border-radius:10px;padding:10px 14px;cursor:pointer;
      background:var(--accent);color:#fff;font-weight:600
    }
    button[disabled]{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:#374151}
    .stack{display:grid;gap:8px}
    .hint{font-size:13px;color:var(--muted)}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#111827; color:#d1d5db; border-radius:999px; padding:6px 10px; font-size:13px}
    input[type="range"]{width:180px;vertical-align:middle}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üì∑ Kamera ‚Äî Suratni Saqlash</h1>
      <p class="hint">Sahifa HTTPS yoki <code>localhost</code> orqali ochilishi kerak. Ruxsat berilgach, old kameradan rasm olinadi.</p>

      <div class="media">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas" class="hidden"></canvas>
        <img id="preview" class="hidden" alt="Olingan surat previewi" />
      </div>

      <div class="row">
        <span class="pill">
          Sifat (JPEG):
          <input id="quality" type="range" min="50" max="100" value="92">
          <span id="qVal">92%</span>
        </span>
        <span class="pill">
          Avtomatik surat (ms):
          <input id="delay" type="range" min="0" max="3000" step="100" value="700">
          <span id="dVal">700</span>
        </span>
        <span class="pill">
          O‚Äòlcham: <span id="sizeLbl">‚Äî</span>
        </span>
      </div>

      <div class="row">
        <button id="startBtn">üé¨ Kamerani yoqish</button>
        <button id="shotBtn" class="btn-secondary" disabled>üì∏ Surat olish</button>
        <button id="saveBtn" disabled>‚¨áÔ∏è Yuklab olish</button>
        <button id="shareBtn" class="btn-secondary" disabled>üîó Share / Saqlash</button>
        <button id="retakeBtn" class="btn-secondary hidden">‚ôªÔ∏è Qayta olish</button>
      </div>

      <div class="stack" style="margin-top:10px">
        <details>
          <summary>üì± Fallback: fayldan tanlash (agar kamera ishlamasa)</summary>
          <input id="fileInput" type="file" accept="image/*" capture="user">
          <p class="hint">iOS/Safari‚Äôda ba‚Äôzan shu variant yaxshiroq ishlaydi.</p>
        </details>
        <p id="status" class="hint">Holat: tayyor.</p>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');

    const startBtn = document.getElementById('startBtn');
    const shotBtn  = document.getElementById('shotBtn');
    const saveBtn  = document.getElementById('saveBtn');
    const shareBtn = document.getElementById('shareBtn');
    const retakeBtn= document.getElementById('retakeBtn');
    const statusEl = document.getElementById('status');

    const quality  = document.getElementById('quality');
    const qVal     = document.getElementById('qVal');
    const delay    = document.getElementById('delay');
    const dVal     = document.getElementById('dVal');
    const sizeLbl  = document.getElementById('sizeLbl');
    const fileInput= document.getElementById('fileInput');

    let stream = null;
    let lastBlob = null;
    let lastURL = null;

    // UI updates
    quality.addEventListener('input', ()=> qVal.textContent = quality.value + '%');
    delay.addEventListener('input', ()=> dVal.textContent = delay.value);

    function setStatus(msg){ statusEl.textContent = 'Holat: ' + msg; }

    function revokeLastURL(){
      if(lastURL){ URL.revokeObjectURL(lastURL); lastURL = null; }
    }

    function setButtons({started=false, canShot=false, hasPhoto=false}){
      startBtn.disabled = started;
      shotBtn.disabled  = !canShot;
      saveBtn.disabled  = !hasPhoto;
      shareBtn.disabled = !hasPhoto;
      retakeBtn.classList.toggle('hidden', !hasPhoto);
    }

    // Start camera with front camera preference and a reasonable resolution
    async function startCamera(){
      setStatus('Kamera ruxsati so‚Äòralmoqda...');
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video:{
            facingMode: { ideal: 'user' },
            width:  { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio:false
        });
        video.srcObject = stream;
        await waitForVideoReady(video);
        sizeLbl.textContent = `${video.videoWidth || '‚Äî'} √ó ${video.videoHeight || '‚Äî'}`;
        setStatus('Kamera ishga tushdi.');
        setButtons({started:true, canShot:true, hasPhoto:false});

        // Auto shot after delay
        const ms = parseInt(delay.value, 10) || 0;
        if(ms >= 0){
          setStatus(`Kadr barqarorlashmoqda‚Ä¶ (${ms}ms)`);
          await sleep(ms);
          if(stream) captureShot();
        }
      }catch(err){
        console.error(err);
        setStatus((err && err.message) ? err.message : 'Kamera ishga tushmadi.');
        // Fallback hint
        setButtons({started:false, canShot:false, hasPhoto:false});
      }
    }

    function waitForVideoReady(el){
      return new Promise((resolve,reject)=>{
        if(el.readyState >= 2) return resolve();
        const t = setTimeout(()=>reject(new Error('Video yuklanmadi')), 8000);
        el.addEventListener('canplay', ()=>{ clearTimeout(t); resolve(); }, {once:true});
      });
    }

    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    // Capture a frame to blob
    async function captureShot(){
      if(!stream || !video.videoWidth) { setStatus('Kamera tayyor emas.'); return; }
      canvas.width = video.videoWidth;
      canvas.height= video.videoHeight;
      const ctx = canvas.getContext('2d', { willReadFrequently: false });
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const q = Math.max(0.5, Math.min(1, parseInt(quality.value,10)/100));
      lastBlob = await new Promise(res=> canvas.toBlob(res, 'image/jpeg', q));
      if(!lastBlob){ setStatus('Blob yaratilmadi.'); return; }

      // show preview
      revokeLastURL();
      lastURL = URL.createObjectURL(lastBlob);
      preview.src = lastURL;
      preview.classList.remove('hidden');
      canvas.classList.add('hidden');
      video.classList.add('hidden');
      setButtons({started:true, canShot:false, hasPhoto:true});
      setStatus(`Rasm olindi (${(lastBlob.size/1024).toFixed(1)} KB).`);
    }

    // Save to device (download)
    function saveToDevice(){
      if(!lastBlob){ return; }
      const a = document.createElement('a');
      const url = URL.createObjectURL(lastBlob);
      a.href = url;
      a.download = `photo_${Date.now()}.jpg`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus('Yuklab berildi. Android‚Äôda ko‚Äòpincha Galereyada paydo bo‚Äòladi; iOS‚Äôda Files‚Äôga borishi mumkin.');
    }

    // Share if available (lets user save to Photos/Gallery)
    async function sharePhoto(){
      if(!lastBlob) return;
      try{
        const file = new File([lastBlob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
        if(navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({ files:[file], title:'Surat' });
          setStatus('Share oynasi yopildi.');
        }else{
          // Fallback to open in a new tab (iOS: long-press ‚Üí Save Image)
          const u = URL.createObjectURL(lastBlob);
          window.open(u, '_blank', 'noopener,noreferrer');
          setStatus('Agar iOS bo‚Äòlsa: ochilgan rasmda uzun bosing ‚Üí "Save Image".');
        }
      }catch(e){
        console.warn(e);
        setStatus('Share bekor qilindi yoki qo‚Äòllab-quvvatlanmaydi.');
      }
    }

    function retake(){
      preview.classList.add('hidden');
      video.classList.remove('hidden');
      lastBlob = null;
      setButtons({started:true, canShot:true, hasPhoto:false});
      setStatus('Qayta olishga tayyor.');
    }

    // Fallback: choose file from camera app
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      lastBlob = f;
      revokeLastURL();
      lastURL = URL.createObjectURL(f);
      preview.src = lastURL;
      preview.classList.remove('hidden');
      video.classList.add('hidden');
      setButtons({started:false, canShot:false, hasPhoto:true});
      setStatus('Fayldan surat tanlandi.');
    });

    // Event bindings
    startBtn.addEventListener('click', startCamera);
    shotBtn.addEventListener('click', captureShot);
    saveBtn.addEventListener('click', saveToDevice);
    shareBtn.addEventListener('click', sharePhoto);
    retakeBtn.addEventListener('click', retake);

    // Auto-start attempt (browser still shows permission prompt)
    window.addEventListener('load', ()=>{
      // iOS ba‚Äôzan avtomatik chaqiruvni yoqtirmaydi; tugma ham qoldirilgan.
      startCamera().catch(()=>{ /* user may tap Start */ });
    });

    // Clean up
    window.addEventListener('beforeunload', ()=>{
      try { stream?.getTracks().forEach(t=>t.stop()); } catch {}
      revokeLastURL();
    });
  </script>
</body>
</html>
