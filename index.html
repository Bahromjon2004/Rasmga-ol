<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kamera â€” Bitta tugma (Apple minimal)</title>
<style>
  :root{
    --bg:#f5f5f7; --fg:#1c1c1e; --card:rgba(255,255,255,.75);
    --accent:#007aff; --radius:22px; --shadow:0 10px 30px rgba(0,0,0,.12);
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0b0c; --fg:#f5f5f7; --card:rgba(22,23,26,.7); --accent:#0a84ff; }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 -apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui}
  header{padding:14px 18px;font-weight:600;letter-spacing:.2px}
  .wrap{display:grid;place-items:center;padding:18px}
  .card{
    width:min(92vw,440px); background:var(--card); backdrop-filter:blur(18px);
    border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
  }
  .stage{position:relative; background:#000}
  video, img{display:block; width:100%; height:auto}
  .bar{padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:8px}
  .hint{font-size:13px; opacity:.7}
  .btn{
    border:0; background:var(--accent); color:#fff; font-weight:700; cursor:pointer;
    width:74px; height:74px; border-radius:50%; box-shadow:var(--shadow);
    display:grid; place-items:center; transition:transform .12s ease, filter .2s ease;
  }
  .btn:active{ transform:scale(.95) }
  .btn[disabled]{opacity:.55; cursor:not-allowed}
  .ghost{background:transparent; color:var(--fg); border:1px solid #00000022; border-radius:12px; padding:10px 12px}
  .flash{position:fixed; inset:0; background:#fff; opacity:0; pointer-events:none; transition:opacity .12s ease; z-index:999}
  .flash.show{opacity:1; transition:opacity .08s ease}
  .sr{position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0)}
</style>
</head>
<body>
  <header>Kamera</header>
  <div class="wrap">
    <div class="card" role="region" aria-label="Kamera oynasi">
      <div class="stage">
        <video id="v" playsinline autoplay muted></video>
        <img id="pv" alt="Olingan surat previewi" style="display:none" />
      </div>
      <div class="bar">
        <div>
          <div class="hint">Bosish bilan kamera ruxsati soâ€˜raladi va surat olinadi.</div>
          <div id="st" class="hint">Holat: tayyor.</div>
        </div>
        <button id="capture" class="btn" aria-label="Rasmga ol">
          <span class="sr">Rasmga ol</span>ðŸ“¸
        </button>
      </div>
      <div class="bar" style="justify-content:flex-end; gap:10px">
        <button id="share" class="ghost" disabled>Share / Saqlash</button>
        <button id="download" class="ghost" disabled>Yuklab olish</button>
        <button id="retake" class="ghost" style="display:none">Qayta olish</button>
      </div>
    </div>
  </div>
  <div class="flash" id="flash" aria-hidden="true"></div>

<script>
(() => {
  const v = document.getElementById('v');
  const pv = document.getElementById('pv');
  const st = document.getElementById('st');
  const btn = document.getElementById('capture');
  const shareBtn = document.getElementById('share');
  const dlBtn = document.getElementById('download');
  const retakeBtn = document.getElementById('retake');
  const flash = document.getElementById('flash');

  let stream = null;
  let lastBlob = null;

  function setStatus(msg){ st.textContent = 'Holat: ' + msg; }
  function flashOnce(){ flash.classList.add('show'); setTimeout(()=>flash.classList.remove('show'), 90); }

  async function ensureStream(){
    if (stream) return stream;
    setStatus('Kamera ruxsati soâ€˜ralmoqdaâ€¦');
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:'user' }, width:{ideal:1280}, height:{ideal:720} }, audio:false
    });
    v.srcObject = stream;
    await new Promise((res,rej)=>{
      if (v.readyState >= 2) return res();
      const t = setTimeout(()=>rej(new Error('Video yuklanmadi')), 8000);
      v.addEventListener('canplay', ()=>{ clearTimeout(t); res(); }, { once:true });
    });
    setStatus('Kamera tayyor. Surat olinmoqdaâ€¦');
    return stream;
  }

  async function takePhoto(){
    await ensureStream(); // bu yerda brauzer ruxsat oynasini koâ€˜rsatadi (foydalanuvchi oâ€˜zi tasdiqlaydi)
    flashOnce();

    const canvas = document.createElement('canvas');
    const w = v.videoWidth || 1280, h = v.videoHeight || 720;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(v, 0, 0, w, h);

    lastBlob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.95));
    const url = URL.createObjectURL(lastBlob);

    // preview
    pv.src = url;
    pv.style.display = 'block';
    v.style.display = 'none';

    setStatus(`Rasm olindi (${(lastBlob.size/1024).toFixed(0)} KB).`);
    shareBtn.disabled = false;
    dlBtn.disabled = false;
    retakeBtn.style.display = 'inline-block';
  }

  function downloadPhoto(){
    if (!lastBlob) return;
    const a = document.createElement('a');
    const url = URL.createObjectURL(lastBlob);
    a.href = url; a.download = `photo_${Date.now()}.jpg`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    setStatus('Yuklab berildi. (Android: Galereyada koâ€˜rinishi mumkin; iOS: Files ga borishi mumkin)');
  }

  async function sharePhoto(){
    if (!lastBlob) return;
    const file = new File([lastBlob], `photo_${Date.now()}.jpg`, { type:'image/jpeg' });
    try{
      if (navigator.canShare && navigator.canShare({ files:[file] })){
        await navigator.share({ files:[file], title:'Surat' });
        setStatus('Share oynasi yopildi.');
      } else {
        // fallback: yangi tabda ochish â€” iOS: uzun bosib â€œSave Imageâ€
        const u = URL.createObjectURL(lastBlob);
        window.open(u, '_blank', 'noopener,noreferrer');
        setStatus('Agar iOS boâ€˜lsa: ochilgan rasmda uzun bosing â†’ â€œSave Imageâ€.');
      }
    }catch(e){
      setStatus('Share bekor qilindi yoki qoâ€˜llab-quvvatlanmaydi.');
    }
  }

  function retake(){
    pv.style.display = 'none';
    v.style.display = 'block';
    lastBlob = null;
    shareBtn.disabled = true;
    dlBtn.disabled = true;
    retakeBtn.style.display = 'none';
    setStatus('Qayta suratga olishga tayyor.');
  }

  btn.addEventListener('click', takePhoto);
  dlBtn.addEventListener('click', downloadPhoto);
  shareBtn.addEventListener('click', sharePhoto);
  retakeBtn.addEventListener('click', retake);

  // tozalash
  window.addEventListener('beforeunload', () => {
    try { stream?.getTracks().forEach(t=>t.stop()); } catch {}
  });
})();
</script>
</body>
</html>
